"use strict";(()=>{var e={};e.id=646,e.ids=[646],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},4718:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,r){return r in t?t[r]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,r)):"function"==typeof t&&"default"===r?t:void 0}}})},6656:(e,t,r)=>{r.r(t),r.d(t,{config:()=>u,default:()=>l,routeModule:()=>d});var i={};r.r(i),r.d(i,{default:()=>c});var n=r(9762),o=r(6059),a=r(4718),s=r(4580);async function c(e,t){if("POST"!==e.method)return t.setHeader("Allow",["POST"]),t.status(405).json({error:"Method not allowed"});try{let r=(e.body||{}).accessToken;if(!r)return t.status(400).json({error:"Access token is required"});let i=await fetch("https://graph.microsoft.com/v1.0/me",{headers:{Authorization:"Bearer "+r}});if(!i.ok)return t.status(401).json({error:"Invalid Microsoft token"});let n=await i.json(),o=await (0,s.z)(),a=await o.collection("users").findOne({microsoftId:n.id});return a?await o.collection("users").updateOne({id:a.id},{$set:{updatedAt:Date.now()}}):(a={id:function(e){let t=Math.random().toString(36).slice(2,8);return e+"_"+Date.now()+"_"+t}("user"),microsoftId:n.id,email:n.mail||n.userPrincipalName,name:n.displayName,createdAt:Date.now(),updatedAt:Date.now()},await o.collection("users").insertOne(a)),t.json({message:"Microsoft authentication successful",user:{id:a.id,email:a.email,name:a.name}})}catch(e){return console.error("Microsoft auth error:",e),t.status(500).json({error:"Failed to authenticate with Microsoft"})}}let l=(0,a.l)(i,"default"),u=(0,a.l)(i,"config"),d=new n.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/auth/microsoft",pathname:"/api/auth/microsoft",bundlePath:"",filename:""},userland:i})},6059:(e,t)=>{var r;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},9762:(e,t,r)=>{e.exports=r(145)},4580:(e,t,r)=>{r.d(t,{z:()=>u});let i=require("node:fs"),n=require("node:path"),o=require("node:url"),a=require("mongodb");!function(){if(process.env.MONGODB_URI)return;let e=n.dirname((0,o.fileURLToPath)("file:///C:/Users/User/Downloads/Habit-Tracker-Web-Project-main(1)/Habit-Tracker-Web-Project-main/server/lib/mongodb.js"));for(let t of[n.join(process.cwd(),".env.local"),n.join(process.cwd(),".env"),n.join(e,"../.env.local"),n.join(e,"../../.env.local")])if((0,i.existsSync)(t))for(let e of(0,i.readFileSync)(t,"utf-8").split(/\r?\n/)){let t=e.trim();if(!t||t.startsWith("#"))continue;let r=t.indexOf("=");if(-1===r||"MONGODB_URI"!==t.slice(0,r).trim())continue;let i=t.slice(r+1).trim();if(!i)continue;let n=i;if((n.startsWith('"')&&n.endsWith('"')||n.startsWith("'")&&n.endsWith("'"))&&(n=n.slice(1,-1)),n=n.trim()){process.env.MONGODB_URI=n;return}}}();let s=process.env.MONGODB_URI;if(!s)throw Error("MONGODB_URI environment variable is not defined");let c=null,l=null;async function u(){return l||(c||(c=new a.MongoClient(s,{serverApi:{version:a.ServerApiVersion.v1,strict:!0,deprecationErrors:!0}}).connect()),l=(await c).db("habit-tracker"))}}};var t=require("../../../webpack-api-runtime.js");t.C(e);var r=t(t.s=6656);module.exports=r})();